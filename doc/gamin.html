<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html">
  <title>Gamin the File Alteration Monitor</title>
</head>

<body style="color: #000000;background-color: #FFFFFF">
<h1 style="text-align: center">Gamin the File Alteration Monitor</h1>

<p>Gamin is a file and directory monitoring system defined to be a subset of
the <a href="http://oss.sgi.com/projects/fam/">FAM</a> (File Alteration
Monitor) system. This is a service provided by a library which allows to
detect when a file or a directory has been modified.</p>

<h2><a name="Overview">Overview</a></h2>

<p>Gamin is a file and directory monitoring system defined to be a subset of
the <a href="http://oss.sgi.com/projects/fam/">FAM</a> (File Alteration
Monitor) system.</p>

<p>The main goals of the project are:</p>
<ol>
  <li>minimize the security model of FAM, the daemon runs under the user
    account, it is compatible with SELinux</li>
  <li>simplify the code base, dropping some of the most exotic feature of
  FAM</li>
  <li>provide an API and ABI compatible replacement for FAM</li>
  <li>try to fix some other issues like resource consumption</li>
</ol>

<p>Gamin also serves as an interface to test the inotify mechanism to improve
the existing dnotify monitoring interface present in the Linux kernel.</p>

<p>At this point Gamin is fairly tied to Linux, portability is not a primary
goal at this stage but if you have portability patches they are welcome.</p>

<p>From an historical point of view, gamin builds from the marmot project
authored by James Willcox and Corey Bowers and then heavilly modified to turn
it into a minimalist FAM replacement (French litterate will appreciate the
filiation from fam to marmot and gamin.)</p>

<p>This library is available under the terms of the <a
href="http://www.gnu.org/copyleft/lesser.html">GNU LIBRARY GENERAL PUBLIC
LICENSE</a>, and a <a
href="http://www.opensource.org/licenses/lgpl-license.php">copy</a> of it
should be found in the source under the COPYING file.</p>

<h2><a name="Using">Using gamin</a></h2>

<p>Basically it is exactly like for using the fam interface. From a
programmer point of view this is the same API, and one can make use of <a
href="http://techpubs.sgi.com/library/tpl/cgi-bin/getdoc.cgi?coll=0650&amp;db=bks&amp;fname=/SGI_Developer/books/IIDsktp_IG/sgi_html/ch08.html">the
existing FAM documentation</a>.</p>

<h2><a name="Config">Configuration</a></h2>

<p>By default gamin should work without needing any configuration, but
sometimes using the kernel notification APIs doesn't work or lead to troubles
(for example when trying to unmount device). By default gamin revert to using
polling for all paths matching <code>/mnt/*</code> or <code>/media/*</code>
on Linux. This may be overriden or extended by the config file
<code>$HOME/.gaminrc</code> . Here is an example of such a configuration
file:</p>
<pre># configuration for gamin
# Can be used to override the default behaviour.
# notify filepath(s) : indicate to use kernel notification
# poll filepath(s)   : indicate to use polling instead
 
notify /mnt/local* /mnt/pictures*
poll /temp/*</pre>

<p>The configuration file accepts only 2 types of command:</p>
<ul>
  <li>notify : to express that kernel monitoring should be used for matching
    paths</li>
  <li>poll: to express that polling should be used for matching paths</li>
</ul>

<p>When checking a path to guess whether polling or kernel notification
should be used, gamin checks first the user provided rules in their
declaration order within the configuration file and then check the predefined
rules. This way the first declaration for <code>/mnt/local*</code> in the
example override the default one for <code>/mnt/*</code> .</p>

<p><em>Caveat: separators in the config file should be spaces, not
tabs.</em></p>

<h2><a name="News">News</a></h2>

<h3>0.0.19: Dec  3 2004</h3>
<ul>
  <li> still chasing the loop bug, made another pass at checking GList,
  added own copy with memory poisonning of GList implementation.</li>
  <li> fixed a compile issue when compiling without debug</li>
</ul>

<h3>0.0.18: Nov 26 2004</h3>
<ul>
  <li> still chasing the loop bug, checked and cleaned up all GList use</li>
  <li> patch from markmc to minimize load on busy apps</li>
</ul>

<h3>0.0.16: Oct 20 2004</h3>
<ul>
  <li> chasing #132354, lot of debugging, checking and testing and a bit
  of refactoring</li>
</ul>

<h3>0.0.15: Oct 16 2004</h3>
<ul>
  <li> workaround to detect loops and avoid the nasty effects, see RedHat bug #132354</li>
</ul>

<h3>0.0.14: Oct  3 2004</h3>
<ul>
  <li> Found and fixed the annoying bug where update were not received
  should fix bugs ##132429, #133665 and #134413</li>
  <li> new mechanism to debug on-the-fly by sending SIGUSR2 to client or server</li>
  <li> Added documentation about internals</li>
</ul>

<h3>0.0.14: Oct  3 2004</h3>
<ul>
  <li>Found and fixed the annoying bug where update were not received should
    fix bugs ##132429, #133665 and #134413 in Red Hat bugzilla</li>
  <li>new mechanism to debug on-the-fly by sending SIGUSR2 to client or
  server</li>
  <li>Added documentation about internals</li>
</ul>

<h3>0.0.13: Oct  1 2004</h3>
<ul>
  <li>applied portability fixes</li>
  <li>hardened the code while chasing a segfault</li>
</ul>

<h3>0.0.12: Sep 30 2004</h3>
<ul>
  <li>potential fix for a hard to reproduce looping problem.</li>
</ul>

<h3>0.0.11: Sep 27 2004</h3>
<ul>
  <li>inotify support compiled in by default</li>
  <li>fix ABI FAM compatibility problems #133162</li>
  <li>update to the latest version of inotify </li>
</ul>

<h3>0.0.10: Sep 21 2004</h3>
<ul>
  <li>fixed API/ABI incompatibility between FAM and gamin about FAMErrno and
    FamErrlist</li>
  <li>added support for a per-user configuration file $HOME/.gaminrc</li>
  <li>applied a portability patch from Michael Banck</li>
  <li>extended the documentation</li>
</ul>

<h3>0.0.9: Sep 1 2004</h3>
<ul>
  <li>fix konqueror crash Red Hat bug #130967</li>
  <li>statically excludes /mnt//* /media//* from kernel monitoring to avoid
    umount problems</li>
</ul>

<h3>0.0.8: Aug 26 2004</h3>
<ul>
  <li>inotify backend patch (Martin Schlemmer)</li>
  <li>documentation</li>
  <li>fixed 0.0.7 crashes</li>
  <li>fixed the kernel/poll detection code which was buggy</li>
</ul>

<h3>0.0.7: Aug 24 2004</h3>
<ul>
  <li>increased the test suite</li>
  <li>activate poll and kernel monitoring (dnotify) simultaneously</li>
  <li>fix monitoring of resources initially missing</li>
  <li>fix load problem due to dnotify on very busy resources</li>
</ul>

<h3>0.0.6: Aug 19 2004</h3>
<ul>
  <li>fix monitoring of file resources</li>
  <li>moved gam_server to $libexec since it doesn't need to be started from
    the command line usually</li>
  <li>test and fixes on x86_64</li>
  <li>removal all thread dependancies and conditional code</li>
</ul>

<h2><a name="Downloads">Downloads</a></h2>

<p>You can download gamin from the GNOME project pages, either as <a
href="http://www.gnome.org/~veillard/gamin/sources/">sources</a>, and <a
href="http://www.gnome.org/~veillard/gamin/RPMS/">binaries</a> or <a
href="http://www.gnome.org/~veillard/gamin/SRPMS/">source</a> RPMs.</p>

<h2><a name="Developers">Developers</a> informations</h2>

<p>The CVS base is in the <a href="http://www.gnome.org/">GNOME</a> project
CVS base at cvs.gnome.org, the module name is <a
href="http://cvs.gnome.org/viewcvs/gamin/"><strong>gamin</strong></a>. See
the <a href="http://developer.gnome.org/tools/cvs.html">Gnome CVS Tools</a>
page for more information on using CVS.</p>

<p>We expect bug reports to be entered in <a
href="http://bugzilla.gnome.org/buglist.cgi?product=gamin&amp;bug_status=UNCONFIRMED&amp;bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=NEEDINFO&amp;bug_status=REOPENED&amp;bug_status=RESOLVED&amp;bug_status=VERIFIED&amp;form_name=query">GNOME
bugzilla</a> or in <a
href="https://bugzilla.redhat.com/bugzilla/buglist.cgi?product=Fedora+Core&amp;product=Red+Hat+Enterprise+Linux&amp;component=fam&amp;component=gamin&amp;bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=REOPENED&amp;bug_status=MODIFIED&amp;short_desc_type=allwordssubstr&amp;short_desc=&amp;long_desc_type=allwordssubstr&amp;long_desc=&amp;Search=Search">Red
Hat bugzilla</a>.</p>

<h2><a name="Contacts">Contacts</a></h2>

<p>The best way to contact the developers is to use the mailing-list <a
href="http://mail.gnome.org/mailman/listinfo/gamin-list">gamin-list@gnome.org</a>.</p>

<p>Before reporting a bug please double-check:</p>
<ul>
  <li>that you are using the <a
    href="http://www.gnome.org/~veillard/gamin/sources/">latest
  version</a></li>
  <li>that the bug hasn't been reported previously in <a
    href="http://bugzilla.gnome.org/buglist.cgi?product=gamin&amp;bug_status=UNCONFIRMED&amp;bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=NEEDINFO&amp;bug_status=REOPENED&amp;bug_status=RESOLVED&amp;bug_status=VERIFIED&amp;form_name=query">GNOME</a>
    or <a
    href="https://bugzilla.redhat.com/bugzilla/buglist.cgi?product=Fedora+Core&amp;product=Red+Hat+Enterprise+Linux&amp;component=fam&amp;component=gamin&amp;bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=REOPENED&amp;bug_status=MODIFIED&amp;short_desc_type=allwordssubstr&amp;short_desc=&amp;long_desc_type=allwordssubstr&amp;long_desc=&amp;Search=Search">Red
    Hat</a> bugzillas.</li>
</ul>

<p>Then the best way is to log the bug in one of the bugzilla or <a
href="http://mail.gnome.org/mailman/listinfo/gamin-list">join the list</a>
and post there if you think that some of gamin design or code should be
changed. If you can provide a <a href="debug.html">testgam</a> scenario
reproducing the problem this would really help getting it debugged and fixed,
see examples in tests/scenario/ .</p>

<h2><a name="FAQ">FAQ</a></h2>

<p>This will be created as user feedback is provided.</p>

<h2><a name="Debug">Debugging Gamin</a></h2>
<ul>
  <li><a href="#Debugging">Debugging support in gamin</a></li>
  <li><a href="#Debugging1">Debugging a running program</a></li>
  <li><a href="#Debugging2">Debugging and testing client</a></li>
</ul>

<h3><a name="Debugging">Debugging support in gamin</a>:</h3>

<p>Both the client and server side, if compiled with debug support accept an
environment variable <strong>GAM_DEBUG</strong> which is set will make them
report debugging informations to stdout.</p>

<p>Usually for debugging you also want to use a dedicated server process so
setting the <strong>GAM_CLIENT_ID</strong> environment allows to ensure this.
Usually one also want to keep control over the server lifetime and not have
it exit automatically after 30 seconds without connection, there is a command
line flag <strong>--notimeout</strong> to <strong>gam_server</strong> for
this.</p>

<p>A typical example of a debugging session using 2 shells would be:</p>
<pre>shell1: export GAM_DEBUG=
shell1: gam_server --notimeout test</pre>

<p>to run the server in debug mode using the ID "test"</p>
<pre>shell2: export GAM_DEBUG=
shell2: export GAM_CLIENT_ID=test
shell2: gamin_client</pre>

<p>to run the client in a verbose session. It is perfectly possible to also
run the client under a debugger, for the server it works too except the
dnotify kernel interface uses a signal SIG33 which is trapped by gdb. To
avoid this use the handle gdb instruction:</p>
<pre>(gdb) handle SIG33 nostop
Signal        Stop      Print   Pass to program Description
SIG33         No        Yes     Yes             Real-time event 33
(gdb)</pre>

<p>even better add it to your <strong>$HOME/.gdbinit</strong> .</p>

<h3><a name="Debugging1">Debugging a running program</a>:</h3>

<p>Both the gam_server and client of the gamin library can get switched
dynamically to a debug mode by sending them a signal SIGUSR2. In that case
the program or library switches to verbose debugging and outputs the traces
to a new file /tmp/gamin_debug_XXXXXX . Sending the signal again to the
application or the server should switch off debugging.</p>

<h3><a name="Debugging2">Debugging and testing client</a>:</h3>

<p>A debugging client program called <strong>testgam</strong> is also
available in the tests subdirectory. It allow to use the interface and
monitor the flow of event received. Here is an example of a session:</p>
<pre>paphio:~/gamin/tests -&gt; export GAMIN_DEBUG_SERVER="../server/gam_server"
paphio:~/gamin/tests -&gt; ./testgam -
&gt; connect test
connected to test
&gt;</pre>

<p>The environment variable can be used to specify the path to the server to
run, then <strong>testgam</strong> is launched in interactive mode (argument
<strong>-</strong> ) and the program is asked to connect to the server for
session test (the server will be started on-demand by the library if
needed).</p>
<pre>&gt; mkdir temp
mkdir temp
&gt; mkfile temp/foo
mkfile temp/foo
&gt; mondir temp
mondir temp 0
&gt;
1: /u/veillard/gamin/tests/temp Exists: NULL
1: foo Exists: NULL
1: /u/veillard/gamin/tests/temp EndExist: NULL
&gt; mkfile temp/bar
mkfile temp/bar
&gt;
1: bar Created: NULL
&gt; rmfile temp/foo
rmfile temp/foo
&gt;
1: foo Deleted: NULL
&gt;</pre>

<p>In this example a new directory is created with a file in it and then
monitored, then the directory content is modified. The
<strong>testgam</strong> program also poll and report events coming from the
server as they arrive.</p>

<h2><a name="Security">Security</a></h2>

<p>While gamin still use a server to provide the service (ideally if the
kernel had a proper interface a library only implementation should be doable
and possibly better), it tries to avoid security hazard associated to
contacting an external server process:</p>
<ul>
  <li>the server runs under the same privilege level as the client, by
    running under the uid, no root or superuser access is involved, this is
    checked by both side using kernel support for the checking</li>
  <li>when possible (e.g. on Linux) the socket used to communicate is not
    mapped at the filesystem level to avoid risks related to opening a real
    file, if the kernel doesn't allow this a per user directory holding the
    socket is used and appropriate rights are checked.</li>
  <li>to limit DoS attacks done by continuously modifying a monitored
    resource, the daemon will switch back monitoring of very busy resources
    to polling with generation of events only once per second.</li>
</ul>

<p>Here is the process used to acquire and create the sockets:</p>

<h3>If there is abstract socket support:</h3>

<p>Use the filename "\0/tmp/fam-$USER-$GAM_CLIENT_ID". They are not mapped on
the filesystem, no attack is possible that way. The client and the server
checks on the first '\0' byte received from the socket that the other side is
running under the same UID.</p>

<h3>If there is no abstract socket support:</h3>

<p>On the server side:</p>
<pre> start:
  try to create /tmp/fam-$USER using mkdir('/tmp/fam-$USER', 007)
  if error:
      make a stat() on it
      if doesn't exist:
          return failure to create
      if user is not getuid() or mode is not 007 or type is not dir:
          try to unlink()
          if error:
              exit with error.
          if success:
              goto start:
                                                                                
  do the socket()/bind() on /tmp/fam-$USER/fam-$GAM_CLIENT_ID</pre>

<p>On the client side:</p>
<pre>  make a stat on /tmp/fam-$USER
  if doesn't exist:
      return failure to create should start the server
  if user is not getuid() or mode is not 007 or type is not dir:
      try to unlink()
      if error:
          exit with error.
      if success:
          return failure should start the server
  make a stat on /tmp/fam-$USER/fam-$GAM_CLIENT_ID
  if doesn't exist:
      return failure to create should start the server
  if user is not getuid() or type is not socket:
      try to unlink()
      if error:
          exit with error.
      if success:
          return failure should start the server
                                                                                
  do the socket()/connect() on /tmp/fam-$USER/fam-$GAM_CLIENT_ID</pre>

<p>The client and the server checks on the first '\0' byte received that the
other side is of the same UID.</p>

<h2><a name="Internals">Internals</a></h2>

<p>gamin uses a client server model, this is in a large measure justified by
the inappropriate dnotify kernel API way to signal modification events to an
application but also to share kernel signal when multiple application
monitors the same resource. It also allow to fine tune and filters event flow
in the daemon, potentially minimizing resource consumption in
applications.</p>

<p><img src="client_server.gif" alt="One server and two client connected"></p>

<p>Internally the gam_server maintain various data structures:</p>
<ul>
  <li>A tree of monitored nodes, using both GamNode structure containing
    specific informations (like the path, the subscriptions list for that
    node, monitoring data and whether it's a directory), the tree itself is
    based on a GNode N-ary tree.</li>
  <li>Per connection data (GamConnData) one per connected socket. The data
    includes state, connection informations (file descriptor, Glib I/O
    Channel, pid of the application), and potential unprocessed yet data
    request from the socket.</li>
  <li>Listener information, keeps the list of subscriptions for the connected
    application, this could probably be merged in the connection data.</li>
  <li>For each path monitored by an application, a specific GamSubscription
    structure is maintained. The subscriptions are referenced both from the
    monitored nodes tree and from the listeners.</li>
</ul>

<p><img src="server_structs.gif"
alt="the data structures present in the server"></p>

<p></p>
</body>
</html>
